<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden"
      style='--select-button-svg: url(&apos;data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(104,130,115)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e&apos;); font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'
    >
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f1f4f2] px-10 py-3">
          <div class="flex items-center gap-4 text-[#121714]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor"></path>
              </svg>
            </div>
            <h2 class="text-[#121714] text-lg font-bold leading-tight tracking-[-0.015em]">Pet Grooming</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8" id="header-auth-buttons">
            <!-- Default links for this page; js/auth.js will adjust based on login status -->
            <div class="flex items-center gap-9">
                <a class="text-[#121714] text-sm font-medium leading-normal" href="landing_page.html">Home</a>
                <!-- Authenticated links like My Pets, My Appointments, Profile, Logout will be inserted here by js/auth.js if logged in -->
                <!-- If not logged in, user will be redirected or Login/Sign up will show -->
            </div>
             <!-- Notification Bell and User Icon can be part of the authenticated view if desired -->
             <button
                class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-[#f1f4f2] text-[#121714] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5"
                style="display: none;" <!-- Initially hidden, shown by auth.js if logged in and relevant -->
              >
                <div class="text-[#121714]" data-icon="Bell" data-size="20px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                    ></path>
                  </svg>
                </div>
              </button>
              <div
                class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
                style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCKVfcph9UMA2IN9RhWKDADH4En1MbRkwTIkajQ0_oNNmKqEKbRgXWvBvsdJEoCcEDQyJ7n2CZ62WDY9g32-nHK95oXUiSmhH6U8Dy80atjTLVySDupcCpJiH5f5Yq3-HtYsjUUVb6899UNHZiUdRQs5i1OJAAtlqf3X_9Bzkymyp-_YmzDIbvgB4gQw9gLqb9S59OzbFjLHTQSkLIjOMb75G6vppB-fiB23SUljEWfPcHiXlcL0fRhfTpT2M4SwltMpQqqrP41WhqA"); display: none;' <!-- Initially hidden -->
              ></div>
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <p class="text-[#121714] tracking-light text-[32px] font-bold leading-tight min-w-72">Prenota un Appuntamento</p>
            </div>
            <!-- Removed the static image/details section for brevity, form is primary -->
            <form id="book-appointment-form" class="space-y-6 p-4 max-w-lg mx-auto">
              <div>
                <label for="serviceId" class="block text-[#121714] text-base font-medium leading-normal pb-2">Seleziona Servizio</label>
                <select id="serviceId" name="serviceId" required class="form-select block w-full mt-1 rounded-xl border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 h-14 p-[15px]">
                  <option value="">Caricamento servizi...</option>
                </select>
              </div>

              <div>
                <label for="petId" class="block text-[#121714] text-base font-medium leading-normal pb-2">Seleziona Animale</label>
                <select id="petId" name="petId" required class="form-select block w-full mt-1 rounded-xl border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 h-14 p-[15px]">
                  <option value="">Caricamento animali...</option>
                </select>
              </div>

              <div>
                <label for="appointmentDate" class="block text-[#121714] text-base font-medium leading-normal pb-2">Seleziona Data</label>
                <input type="date" id="appointmentDate" name="appointmentDate" required class="form-input block w-full mt-1 rounded-xl border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 h-14 p-[15px]">
              </div>

              <div>
                <label for="appointmentTime" class="block text-[#121714] text-base font-medium leading-normal pb-2">Seleziona Ora</label>
                <input type="time" id="appointmentTime" name="appointmentTime" required class="form-input block w-full mt-1 rounded-xl border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 h-14 p-[15px]">
              </div>

              <div>
                <label for="notes" class="block text-[#121714] text-base font-medium leading-normal pb-2">Note Aggiuntive</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Richieste speciali o note?" class="form-textarea block w-full mt-1 rounded-xl border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-[15px]"></textarea>
              </div>

              <div id="message-div" class="text-sm py-2"></div>

              <div class="flex pt-3">
                <button type="submit" class="flex min-w-[84px] w-full cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 bg-[#38e07b] hover:bg-green-500 text-[#121714] text-base font-bold leading-normal tracking-[0.015em]">
                  <span class="truncate">Prenota Appuntamento</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="js/auth.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const appointmentForm = document.getElementById('book-appointment-form');
        const serviceSelect = document.getElementById('serviceId');
        const petSelect = document.getElementById('petId');
        const messageDiv = document.getElementById('message-div');
        
        let user = JSON.parse(localStorage.getItem('user'));
        if (!user || !user.id) {
            window.location.href = 'login.html';
            return;
        }
        const userId = user.id;

        // Fetch Services
        try {
            const servicesResponse = await fetch('/api/services');
            if (!servicesResponse.ok) throw new Error('Failed to load services.');
            const services = await servicesResponse.json();
            serviceSelect.innerHTML = '<option value="">Scegli un servizio</option>'; // Clear loading
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = \`\${service.name} - â‚¬\${service.price.toFixed(2)}\`;
                serviceSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching services:', error);
            serviceSelect.innerHTML = '<option value="">Could not load services</option>';
            messageDiv.textContent = error.message; 
            messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
        }

        // Fetch User's Pets
        try {
            const petsResponse = await fetch(\`/api/pets?user_id=\${userId}\`);
            if (!petsResponse.ok) throw new Error('Failed to load pets.');
            const pets = await petsResponse.json();
            petSelect.innerHTML = '<option value="">Scegli il tuo animale</option>'; // Clear loading
            if (pets.length === 0) {
                 petSelect.innerHTML = '<option value="">Nessun animale registrato. <a href="add_pet.html" class="text-green-600 hover:underline">Aggiungine uno!</a></option>';
            } else {
                pets.forEach(pet => {
                    const option = document.createElement('option');
                    option.value = pet.id;
                    option.textContent = pet.name;
                    petSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error fetching pets:', error);
            petSelect.innerHTML = '<option value="">Could not load pets</option>';
            messageDiv.textContent = error.message;
            messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
        }

        appointmentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            messageDiv.textContent = ''; 
            messageDiv.className = 'text-sm'; // Reset to neutral class

            const appointmentData = {
                service_id: serviceSelect.value,
                pet_id: petSelect.value,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                notes: document.getElementById('notes').value,
                user_id: userId
            };

            if (!appointmentData.service_id || !appointmentData.pet_id || !appointmentData.date || !appointmentData.time) {
                messageDiv.textContent = 'Per favore, compila tutti i campi obbligatori.';
                messageDiv.className = 'text-red-600';
                return;
            }

            try {
                const response = await fetch('/api/appointments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appointmentData),
                });
                const responseData = await response.json();

                if (response.ok) {
                    messageDiv.textContent = responseData.message || 'Appuntamento prenotato con successo!';
                    messageDiv.className = 'text-green-700 bg-green-100 border border-green-400 p-3 rounded-md my-2';
                    appointmentForm.reset();
                    setTimeout(() => { window.location.href = 'my_appointments.html'; }, 2000);
                } else {
                    messageDiv.textContent = responseData.message || 'Errore durante la prenotazione.';
                    messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
                }
            } catch (error) {
                console.error('Error booking appointment:', error);
                messageDiv.textContent = 'Errore di rete. Riprova.';
                messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
            }
        });
      });
    </script>
  </body>
</html>
