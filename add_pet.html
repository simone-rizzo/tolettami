<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
      <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f1f4f2] px-10 py-3">
          <div class="flex items-center gap-4 text-[#121714]">
            <div class="size-4">
              <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M24 4H6V17.3333V30.6667H24V44H42V30.6667V17.3333H24V4Z" fill="currentColor"></path>
              </svg>
            </div>
            <h2 class="text-[#121714] text-lg font-bold leading-tight tracking-[-0.015em]">Pet Grooming</h2>
          </div>
          <div class="flex flex-1 justify-end gap-8" id="header-auth-buttons">
            <!-- Authenticated Links - default for this page -->
            <div class="flex items-center gap-9">
              <a class="text-[#121714] text-sm font-medium leading-normal" href="book_appointment.html">Prenota</a>
              <a class="text-[#121714] text-sm font-medium leading-normal" href="my_pets.html">I miei animali</a>
              <a class="text-[#121714] text-sm font-medium leading-normal" href="profile.html">Profilo</a>
              <!-- Logout button will be added here by js/auth.js if needed, or this whole div replaced -->
            </div>
            <button
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 bg-[#f1f4f2] text-[#121714] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5"
            >
              <div class="text-[#121714]" data-icon="Bell" data-size="20px" data-weight="regular">
                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                  ></path>
                </svg>
              </div>
            </button>
            <div
              class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCKVfcph9UMA2IN9RhWKDADH4En1MbRkwTIkajQ0_oNNmKqEKbRgXWvBvsdJEoCcEDQyJ7n2CZ62WDY9g32-nHK95oXUiSmhH6U8Dy80atjTLVySDupcCpJiH5f5Yq3-HtYsjUUVb6899UNHZiUdRQs5i1OJAAtlqf3X_9Bzkymyp-_YmzDIbvgB4gQw9gLqb9S59OzbFjLHTQSkLIjOMb75G6vppB-fiB23SUljEWfPcHiXlcL0fRhfTpT2M4SwltMpQqqrP41WhqA");'
            ></div>
            <!-- End of Authenticated Links -->
          </div>
        </header>
        <div class="px-40 flex flex-1 justify-center py-5">
          <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <p id="form-title" class="text-[#121714] tracking-light text-[32px] font-bold leading-tight min-w-72">Aggiungi un Animale</p>
            </div>
            <form id="add-pet-form" class="space-y-4 p-4">
              <div>
                <label for="petName" class="block text-[#121714] text-base font-bold leading-tight mb-1">Nome dell'Animale</label>
                <input type="text" id="petName" name="petName" required placeholder="Inserisci il nome del tuo animale" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 placeholder:text-[#648772] p-[15px] text-base font-normal leading-normal">
              </div>
              <div>
                <label for="petType" class="block text-[#121714] text-base font-bold leading-tight mb-1">Tipo di Animale</label>
                <input type="text" id="petType" name="petType" placeholder="Es. Cane, Gatto" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 placeholder:text-[#648772] p-[15px] text-base font-normal leading-normal">
              </div>
              <div>
                <label for="petBreed" class="block text-[#121714] text-base font-bold leading-tight mb-1">Razza</label>
                <input type="text" id="petBreed" name="petBreed" placeholder="Es. Labrador, Siamese" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 placeholder:text-[#648772] p-[15px] text-base font-normal leading-normal">
              </div>
              <div>
                <label for="petSize" class="block text-[#121714] text-base font-bold leading-tight mb-1">Taglia</label>
                <select id="petSize" name="petSize" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 p-[15px] text-base font-normal leading-normal">
                  <option value="">Seleziona taglia</option>
                  <option value="Small">Piccola</option>
                  <option value="Medium">Media</option>
                  <option value="Large">Grande</option>
                </select>
              </div>
              <div>
                <label for="petWeight" class="block text-[#121714] text-base font-bold leading-tight mb-1">Peso (kg)</label>
                <input type="text" id="petWeight" name="petWeight" placeholder="Es. 10.5" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 placeholder:text-[#648772] p-[15px] text-base font-normal leading-normal">
              </div>
              <div>
                <label for="petGender" class="block text-[#121714] text-base font-bold leading-tight mb-1">Genere</label>
                <select id="petGender" name="petGender" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 p-[15px] text-base font-normal leading-normal">
                  <option value="">Seleziona genere</option>
                  <option value="Male">Maschio</option>
                  <option value="Female">Femmina</option>
                </select>
              </div>
              <div>
                <label for="petAge" class="block text-[#121714] text-base font-bold leading-tight mb-1">Età</label>
                <input type="text" id="petAge" name="petAge" placeholder="Es. 2 anni, 6 mesi" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#111714] focus:outline-0 focus:ring-0 border border-[#dce5df] bg-white focus:border-[#dce5df] h-14 placeholder:text-[#648772] p-[15px] text-base font-normal leading-normal">
              </div>
              <div id="message-div" class="text-sm py-2"></div>
              <div class="flex pt-3">
                <button
                  type="submit"
                  id="submit-button"
                  class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-12 px-5 flex-1 bg-[#38e07b] hover:bg-green-500 text-[#121714] text-base font-bold leading-normal tracking-[0.015em]"
                >
                  <span class="truncate">Aggiungi Animale</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="js/auth.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const addPetForm = document.getElementById('add-pet-form');
        const messageDiv = document.getElementById('message-div');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button').querySelector('span');

        const urlParams = new URLSearchParams(window.location.search);
        const editPetId = urlParams.get('edit_pet_id');
        let user = JSON.parse(localStorage.getItem('user'));

        if (!user || !user.id) {
            window.location.href = 'login.html';
            return;
        }
        const userId = user.id;

        if (editPetId) {
            formTitle.textContent = 'Modifica Animale';
            submitButton.textContent = 'Salva Modifiche';

            // Fetch existing pet data to populate the form
            try {
                const response = await fetch(`/api/pets?user_id=${userId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch pet data for editing.');
                }
                const pets = await response.json();
                const petToEdit = pets.find(p => p.id == editPetId);

                if (petToEdit) {
                    document.getElementById('petName').value = petToEdit.name || '';
                    document.getElementById('petType').value = petToEdit.type || '';
                    document.getElementById('petBreed').value = petToEdit.breed || '';
                    document.getElementById('petSize').value = petToEdit.size || '';
                    document.getElementById('petWeight').value = petToEdit.weight || '';
                    document.getElementById('petGender').value = petToEdit.gender || '';
                    document.getElementById('petAge').value = petToEdit.age || '';
                } else {
                    messageDiv.textContent = 'Pet non trovato per la modifica.';
                    messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
                }
            } catch (error) {
                console.error('Error fetching pet for edit:', error);
                messageDiv.textContent = error.message || 'Errore nel caricamento dei dati dell\'animale.';
                messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
            }
        }

        addPetForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            messageDiv.textContent = ''; 
            messageDiv.className = 'text-sm'; // Reset to neutral class

            if (!user || !user.id) { // Re-check user, might have logged out
                window.location.href = 'login.html';
                return;
            }

            const petData = {
                name: document.getElementById('petName').value,
                type: document.getElementById('petType').value,
                breed: document.getElementById('petBreed').value,
                size: document.getElementById('petSize').value,
                weight: document.getElementById('petWeight').value,
                gender: document.getElementById('petGender').value,
                age: document.getElementById('petAge').value,
                user_id: userId 
            };

            let url = '/api/pets';
            let method = 'POST';

            if (editPetId) {
                url = `/api/pets/${editPetId}`;
                method = 'PUT';
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(petData),
                });

                const responseData = await response.json();

                if (response.ok) {
                    messageDiv.textContent = responseData.message || (editPetId ? 'Animale aggiornato con successo!' : 'Animale aggiunto con successo!');
                    messageDiv.className = 'text-green-700 bg-green-100 border border-green-400 p-3 rounded-md my-2';
                    addPetForm.reset();
                    setTimeout(() => {
                        window.location.href = 'my_pets.html';
                    }, 1500);
                } else {
                    messageDiv.textContent = responseData.message || 'Si è verificato un errore.';
                    messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                messageDiv.textContent = 'Si è verificato un errore di rete. Riprova.';
                messageDiv.className = 'text-red-700 bg-red-100 border border-red-400 p-3 rounded-md my-2';
            }
        });
      });
    </script>
  </body>
</html>
